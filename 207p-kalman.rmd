---
output:
  pdf_document: default
  html_document: default
---

STATS 207 Project RMD

```{r}
library(astsa)
library(Metrics)
library(xts)
library(dlm)
library(ggplot2)
library(TSstudio)

## Import data and preprocess data
## We use the closing data here
## For Kalman filtering specifically, use monthly close intervals rather than daily ones
## Test sample over the most recent six months
full_ark <- read.csv('ARKGFULL.csv')
full_ark$Date <- as.Date(full_ark$Date)
fulla_ts <- as.ts(full_ark$Close, full_ark$Date)

full_qqq <- read.csv('QQQFULL.csv')
full_qqq$Date <- as.Date(full_qqq$Date)
fullq_ts <- as.ts(full_qqq$Close, full_qqq$Date)

full_schf <- read.csv('SCHFFULL.csv')
full_schf$Date <- as.Date(full_schf$Date)
fulls_ts <- as.ts(full_schf$Close, full_schf$Date)

full_vt <- read.csv('VTFULL.csv')
full_vt$Date <- as.Date(full_vt$Date)
fullv_ts <- as.ts(full_vt$Close, full_vt$Date)

full_xlf <- read.csv('XLFFULL.csv')
full_xlf$Date <- as.Date(full_xlf$Date)
fullx_ts <- as.ts(full_xlf$Close, full_xlf$Date)
```

```{r}
## Kalman Filtering
split_df <- ts_split(ts.obj = fulla_ts, sample.out = 6)

training = split_df$train

model <- function(p) {
  return(dlmModPoly(2, dV = p[1], dW = p[2:3]) + dlmModSeas(12, dV = p[4]))
}

## Parameter Estimation
mle <- dlmMLE(training, parm = c(0.1,0.001,1,1), build = model)
if (mle$convergence == 0) print ('converge') else print('nonconverge')
mle$par
modelfit = model(mle$par)

## Filtering and Smoothing
modelfilter <- dlmFilter(training, modelfit)
modelsmoothed <- dlmSmooth(training, modelfit)
```

```{r}
n <- 1*6
a6_forecast <- dlmForecast(modelfilter, nAhead = n)

x <- index(training)
xf <- seq(max(x), max(x) + n/12, 1/12)
aa <- forecast$a[,1]* (-1)
aa <- cbind(forecast$a[,1], aa)
a <- drop(forecast$a%*%t(FF(modelfit)))
a <- c(tail(training, 1), a)
df <- rbind(
  data.frame(x = x, y = as.numeric(training), series = "original"),
  data.frame(x = x, y = apply(modelfilter$m[-1,1:2],1,sum), series = "filtered"),
  data.frame(x = x, y = apply(modelsmoothed$s[-1,1:2],1,sum), series = "smoothed"),
  data.frame(x = xf, y = a, series = "forecast")
)

dlm <- ggplot(subset(df, x > 730), aes(x=x, y=y, colour = series)) + geom_line()
dlm
```

```{r}
n <- 1*24
a24_forecast <- dlmForecast(modelfilter, nAhead = n)

x <- index(training)
xf <- seq(max(x), max(x) + n/12, 1/12)
aa <- forecast$a[,1]* (-1)
aa <- cbind(forecast$a[,1], aa)
a <- drop(forecast$a%*%t(FF(modelfit)))
a <- c(tail(training, 1), a)
df <- rbind(
  data.frame(x = x, y = as.numeric(training), series = "original"),
  data.frame(x = x, y = apply(modelfilter$m[-1,1:2],1,sum), series = "filtered"),
  data.frame(x = x, y = apply(modelsmoothed$s[-1,1:2],1,sum), series = "smoothed"),
  data.frame(x = xf, y = a, series = "forecast")
)

dlm <- ggplot(subset(df, x > 730), aes(x=x, y=y, colour = series)) + geom_line()
dlm
```